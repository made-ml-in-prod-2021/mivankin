Второе ДЗ
==============================

Домашнее задание по дисциплине "Машинное обучение в продакшене"

Что реализовано
------------
    - rest сервис на основе FastAPI
    - Тесты для сервиса, в том числе для /predict
    - Скрипт для запросов к сервису
    - Валидация входных данных
    - Написан Dockerfile, собран образ, запущен локально контейнер с сервисом
    - Реализована возможность запуска тестов из docker контейнера
    - Образ опублирован в https://hub.docker.com/
    
<p><small>Project based on the <a target="_blank" href="https://drivendata.github.io/cookiecutter-data-science/">cookiecutter data science project template</a>. #cookiecutterdatascience</small></p>

Сборка образа
------------
    docker build -t mivankin/ml_prod_hw2:0.0.2 .
    
или 
    
    docker pull mivankin/ml_prod_hw2:0.0.1 не оптимизированный на основе python 3.7 (вес локально 1.3 GB, docker hub 527.98 MB)
    docker pull mivankin/ml_prod_hw2:0.0.2 оптимизированный на основе python 3.9:slim (вес локально 700 MB, docker hub 299.96 MB)
    
Запуск образа
------------
    docker run --rm -p 8000:8000 mivankin/ml_prod_hw2:0.0.1
    
    После этого сервис предложит перейти по адрессу 0.0.0.0:8000, но для корректной работы используйте 127.0.0.1:8000
    
Запуск скрипта для запросов к сервису
------------
    1) Смотрим запущенный образ через docker ps
    2) находим и запоминаем CONTAINER ID запущенного образа, например er4567
    3) docker exec -it er4567 /bin/bash
    4) Запускаем скрипт python make_requests.py
    5) ...
    6) PROFIT!!!

Что по валидации входных данных
------------
    Сделал валидацию данных на основе написанного класса для генерации синтетических данных из прошлого дз. 
    Идея заключается в следующем: 
    
    - на основе датасета из загруженной модели расчитываются параметры среднего и дисперсии для каждого параметра модели. 
    - при получении запроса на predict запускается функция validate из модуля, которая сэмплирует из нормального распределения синтетические данные и сравнивает их с входными по тесту Колмогорова-Смирнова.  
    - если сгенерированные данные и полученные для предсказания из разных распределений, то возвращаю 400 c сообщением о том, какой именно параметр не подходит.

Самооценка
------------
Задача понравилась, с докером работал первый раз, с онлайн сервисами второй.
Первый раз делал через flask, теперь с помощью FastAPI. 

Докер по началу показался очень сложной штукой, но потом я разобрался, научился запускать образ и работать через консоль из под него.

Параллельно разобрался с особенностями работы модуля pickle.

Что я сделал:
0) Ветку назвал homework2 и положил код в папку online_inference
1) Обернул inference с помощью FastAPI (3 балла)
2) Написал тесты для сервиса, в том числе для /predict (3 балла)
3) Написал скрипт для запросов, научился запускать его параллельно из-под докер образа во время работы сервиса (2 балла)
4) Сделал валидацию входных данных. Самописный генератор данных из 1 дз очень круто зашел и сюда. И опять работает на основе сэмплирования. 
Для каждого фичи сэмплируются синтетические данные и сравниваются распределения по критерию Колмогорова-Смирнова. Если тест не пройден, то возвращается сообщение 400
с информацией в какой фиче содержатся некорректные данные. Есть проверка в тестах, можете сами попробовать через скрипт для запросов к сервису. (3 доп балла)
5) Написал Dockerfile, собрал образ, запустил локально, все работает (4 балла)
6) Оптимизировал докер образ, за счет использования python-3.9:slim (mivankin/ml_prod_hw2:0.0.1 не оптимизированный на основе python 3.7 
(вес локально 1.3 GB, docker hub 527.98 MB) mivankin/ml_prod_hw2:0.0.2 оптимизированный на основе python 3.9:slim (вес локально 700 MB, docker hub 299.96 MB) (3 доп балла)
7) Опубликовал образ в https://hub.docker.com/ (2 балла)
8) В readme все описано, для того, чтобы удобно пользоваться всем функционалом (1 балл)

Самооценка:
    в целом считаю, все поставленные задачи выполненными. ДЗ очень крутое, но было сложно разбираться с некоторыми моментами.
    Спасибо! 1 балл :)
    
Итого: 22 баллов

Описание ДЗ
------------
Всем привет, с праздниками!
Настало время добавить еще одну домашку, получить за нее можно 15 баллов (+ бонусные). 

СРОКИ(после soft -- баллы * 0.6): 
soft deadline -- до 19 мая включительно
hard deadline -- до 24 мая включительно

Механика проверки такая же(добавляем преподавателя и студента, за сделанное ревью 2 балла).

Задание: 

В прошлом ДЗ вы обучили модель для решения задачи классификации(по умолчанию использовался датасет https://www.kaggle.com/ronitf/heart-disease-uci), новое задание, это обернуть ее в вид, пригодный для использования в режиме онлайн

0) ветку назовите homework2, положите код в папку online_inference

1) Оберните inference вашей модели в rest сервис(вы можете использовать как FastAPI, так и flask, другие желательно не использовать, дабы не плодить излишнего разнообразия для проверяющих), должен быть endpoint /predict (3 балла)

2) Напишите тест для /predict  (3 балла) (https://fastapi.tiangolo.com/tutorial/testing/, https://flask.palletsprojects.com/en/1.1.x/testing/)

3) Напишите скрипт, который будет делать запросы к вашему сервису -- 2 балла

4) Сделайте валидацию входных данных (например, порядок колонок не совпадает с трейном, типы не те и пр, в рамках вашей фантазии)  (вы можете сохранить вместе с моделью доп информацию, о структуре входных данных, если это нужно) -- 3 доп балла
https://fastapi.tiangolo.com/tutorial/handling-errors/ -- возращайте 400, в случае, если валидация не пройдена

5) Напишите dockerfile, соберите на его основе образ и запустите локально контейнер(docker build, docker run), внутри контейнера должен запускать сервис, написанный в предущем пункте, закоммитьте его, напишите в readme корректную команду сборки (4 балл)

6) Оптимизируйте размер docker image (3 доп балла) (опишите в readme.md что вы предприняли для сокращения размера и каких результатов удалось добиться)  -- https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

7) опубликуйте образ в https://hub.docker.com/, используя docker push (вам потребуется зарегистрироваться) (2 балла)

8) напишите в readme корректные команды docker pull/run, которые должны привести к тому, что локально поднимется на inference ваша модель (1 балл)
Убедитесь, что вы можете протыкать его скриптом из пункта 3

5) проведите самооценку -- 1 доп балл
6) создайте пулл-реквест и поставьте label -- hw2